åŸºäºâ€œå…ƒæ•°æ®é©±åŠ¨ï¼ˆMetadata-Drivenï¼‰â€ç†å¿µçš„å®Œæ•´æ¶æ„è§„åˆ’ã€‚

æ ¸å¿ƒæ€æƒ³æ˜¯å°† **ä¸šåŠ¡é€»è¾‘**ï¼ˆå¦‚æ¨¡å‹è®­ç»ƒã€è¡¨æ ¼ç”Ÿæˆï¼‰ä¸ **æ•°æ®å®šä¹‰**ï¼ˆç‰¹å¾åç§°ã€å•ä½ã€å¤„ç†æ–¹å¼ï¼‰å½»åº•è§£è€¦ã€‚ä¸Šå±‚åº”ç”¨ä¸å†ç›´æ¥æ“ä½œ DataFrame çš„åˆ—åï¼Œè€Œæ˜¯é€šè¿‡ `FeatureManager` çš„è¯­ä¹‰åŒ–æ¥å£ä¸åº•å±‚æ•°æ®äº¤äº’ã€‚

### 1. ğŸ“‚ æœ€ç»ˆç¡®å®šçš„ç›®å½•æ ‘ç»“æ„

```text
scripts/core/
â”œâ”€â”€ __init__.py              # æš´éœ²æ ¸å¿ƒå®ä¾‹ (from . import fm)
â”‚
â”œâ”€â”€ spec.py                  # [åè®®å±‚] FeatureSpec æ•°æ®ç±»å®šä¹‰
â”‚                            # ä½œç”¨ï¼šå®šä¹‰ç‰¹å¾çš„å…¨éƒ¨å±æ€§ï¼ˆå•ä½ã€æ˜¾ç¤ºåã€å¡«å……ç­–ç•¥ã€è§’è‰²ç­‰ï¼‰
â”‚
â”œâ”€â”€ feature_registry.py      # [æ•°æ®å±‚] å…¨é‡ç‰¹å¾æ³¨å†Œè¡¨ (Dict[str, FeatureSpec])
â”‚                            # ä½œç”¨ï¼šé™æ€å­˜å‚¨æ‰€æœ‰å˜é‡çš„å…ƒæ•°æ®ï¼Œæ˜¯ Single Source of Truth
â”‚
â”œâ”€â”€ conversion.py            # [åŸå­å±‚] ç‰©ç†å•ä½è½¬æ¢å‡½æ•°åº“ & åˆæ³•æ€§æ£€æŸ¥
â”‚                            # ä½œç”¨ï¼šæä¾› register_conversion è£…é¥°å™¨å’Œ convert_to_si åŸå­é€»è¾‘
â”‚
â”œâ”€â”€ feature_manager.py       # [è°ƒåº¦å±‚] æ ¸å¿ƒå¼•æ“ FeatureManager ç±»
â”‚                            # ä½œç”¨ï¼šè¯­ä¹‰åŒ–æŸ¥è¯¢ç‰¹å¾ã€é©±åŠ¨è‡ªåŠ¨è½¬æ¢ã€ç”Ÿæˆé¢„å¤„ç†é…ç½®
â”‚
â”œâ”€â”€ validator.py             # [å®¡è®¡å±‚] æ•°æ®å“¨å…µ
â”‚                            # ä½œç”¨ï¼šé™æ€æ£€æŸ¥ Registry å®Œæ•´æ€§ï¼›åŠ¨æ€æ£€æŸ¥æ•°æ®åˆ†å¸ƒåˆç†æ€§ (Plausibility Check)
â”‚
â”œâ”€â”€ exporter.py              # [æ–‡æ¡£å±‚] è‡ªåŠ¨åŒ–æ–‡æ¡£ç”Ÿæˆ
â”‚                            # ä½œç”¨ï¼šå°† Registry å¯¼å‡ºä¸º JSON é…ç½®æˆ–é™„å½•ä¸­çš„å˜é‡å®šä¹‰è¡¨
â”‚
â””â”€â”€ engines/                 # [æ‰§è¡Œå±‚] é’ˆå¯¹ç‰¹å®šä»»åŠ¡çš„å­å¼•æ“
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ table_engine.py      # è´Ÿè´£ Table 1 ç”Ÿæˆ (è‡ªåŠ¨åˆ†ç»„ã€ç»Ÿè®¡æ£€éªŒã€LaTeX æ ¼å¼åŒ–)
    â”œâ”€â”€ transform_engine.py  # è´Ÿè´£ Scikit-learn Pipeline é€‚é… (Impute/Scale/Log)
    â””â”€â”€ viz_engine.py        # è´Ÿè´£ç»˜å›¾å¢å¼º (è‡ªåŠ¨æå– LaTeX åæ ‡è½´æ ‡ç­¾ã€ç»Ÿä¸€é…è‰²)

```

---

### 2. ğŸ—ï¸ æ¨¡å—åŠŸèƒ½è¯¦ç»†è§„åˆ’

#### A. æ ¸å¿ƒèµ„äº§ (The Foundation)

è¿™äº›æ–‡ä»¶å®šä¹‰äº†â€œæ•°æ®æ˜¯ä»€ä¹ˆâ€ï¼Œé€šå¸¸ä¸åŒ…å«å¤æ‚çš„æ§åˆ¶æµã€‚

* **`spec.py`**: å®šä¹‰ `FeatureSpec` ç±»ã€‚å®ƒæ˜¯æ•´ä¸ªç³»ç»Ÿçš„â€œåˆåŒâ€ã€‚
* **`feature_registry.py`**: å®ä¾‹åŒ–æ‰€æœ‰ `FeatureSpec`ã€‚ä¾‹å¦‚å®šä¹‰ `creatinine` çš„å•ä½æ˜¯ `mg/dL`ï¼Œè§’è‰²æ˜¯ `feature`ï¼Œæ‰€å±é¢†åŸŸæ˜¯ `renal`ã€‚
* **`conversion.py`**: çº¯ç²¹çš„æ•°å­¦è®¡ç®—ã€‚åŒ…å« `mg/dL -> mmol/L` ç­‰ç¡¬é€»è¾‘ï¼Œä»¥åŠ `unit_plausibility_check` ç®—æ³•ã€‚

#### B. é€»è¾‘ä¸­æ¢ (The Brain)

* **`feature_manager.py` (Class `FeatureManager`)**
* **è¯­ä¹‰æ£€ç´¢**: `get_features(role='outcome', domain='renal')`ã€‚
* **æ¨¡å‹å‡†å¤‡**: `get_model_ready_features()`ï¼ˆè‡ªåŠ¨æ’é™¤ IDã€éšç§ä¿¡æ¯ã€ä¸å…è®¸è¿›å…¥æ¨¡å‹çš„å˜é‡ï¼‰ã€‚
* **ç­–ç•¥ç”Ÿæˆ**: `get_impute_strategies()` ç”Ÿæˆ `{col: 'median'}` å­—å…¸ã€‚
* **ä¸€é”®å¯¹é½**: `align_to_si(df)`ï¼Œåè°ƒ `registry` å’Œ `conversion` å®Œæˆæ•°æ®æ¸…æ´—ã€‚



#### C. è´¨é‡ä¿è¯ (The Guardrails)

* **`validator.py`**
* **Registry å®¡è®¡**: ç¡®ä¿å®šä¹‰äº† `convert` çš„å‡½æ•°åœ¨ `conversion.py` ä¸­çœŸå®å­˜åœ¨ã€‚
* **æ•°æ®å®¡è®¡**: åœ¨è¯»å– CSV åç«‹å³è¿è¡Œï¼Œå¯¹æ¯” `FeatureSpec.ref_range` å’Œå®é™…æ•°æ®åˆ†å¸ƒï¼Œå¦‚æœåå·®è¿‡å¤§ï¼ˆå¦‚å•ä½æé”™ï¼‰ï¼ŒæŠ›å‡ºè­¦å‘Šæˆ–é”™è¯¯ã€‚



#### D. ä»»åŠ¡æ‰§è¡Œå™¨ (The Workers)

è¿™äº›å¼•æ“ä¾èµ– `FeatureManager` æä¾›çš„ä¿¡æ¯æ¥å¹²æ´»ï¼š

* **`engines/table_engine.py`**:
* è¾“å…¥ï¼šDataFrame + FeatureManagerã€‚
* è¡Œä¸ºï¼šè‡ªåŠ¨æ ¹æ® `clinical_domain` å¯¹è¡Œæ’åºï¼Œæ ¹æ® `table_role` å†³å®šåˆ—ï¼Œæ ¹æ®æ•°æ®åˆ†å¸ƒè‡ªåŠ¨é€‰æ‹© MeanÂ±SD æˆ– Median[IQR]ã€‚


* **`engines/transform_engine.py`**:
* è¾“å…¥ï¼šFeatureManagerã€‚
* è¡Œä¸ºï¼šæ„å»º `sklearn.ColumnTransformer`ï¼Œè‡ªåŠ¨å°† Log å˜æ¢å’Œ Z-Score åº”ç”¨äºæ­£ç¡®çš„åˆ—ã€‚


* **`engines/viz_engine.py`**:
* è¾“å…¥ï¼šç‰¹å¾åã€‚
* è¡Œä¸ºï¼šè¿”å› `$\text{Creatinine}_{max} \ (\mu\text{mol/L})$` ä¾› Matplotlib ä½¿ç”¨ã€‚



---

### 3. ğŸŒŠ æ•°æ®æµè½¬å…¨æ™¯å›¾

å½“ä¸€ä¸ªæ–°çš„æ•°æ®é›†ï¼ˆå¦‚ eICU å¤–éƒ¨éªŒè¯é›†ï¼‰è¿›å…¥ç³»ç»Ÿæ—¶ï¼Œå¤„ç†æµç¨‹å¦‚ä¸‹ï¼š

1. **Load**: Pandas è¯»å–åŸå§‹ CSVã€‚
2. **Audit (`validator`)**: æ‰«ææ•°æ®åˆ†å¸ƒã€‚å¦‚æœå‘ç° `wbc` (ç™½ç»†èƒ) çš„ä¸­ä½æ•°æ˜¯ `15000` è€Œ Spec é¢„æœŸæ˜¯ `15` ()ï¼Œç«‹åˆ»æŠ¥è­¦ã€‚
3. **Align (`feature_manager` + `conversion`)**: è°ƒç”¨ `fm.align_to_si(df)`ã€‚æ ¹æ® Spec è‡ªåŠ¨å¯»æ‰¾è½¬æ¢å‡½æ•°ï¼Œä¿®å¤å•ä½ä¸ä¸€è‡´ã€‚
4. **Filter (`feature_manager`)**: è°ƒç”¨ `fm.get_model_ready_features()` è·å–å¹²å‡€çš„åˆ—ååˆ—è¡¨ã€‚
5. **Compute (`engines`)**:
* ä¼ ç»™ `TableEngine` ç”ŸæˆåŸºçº¿è¡¨ã€‚
* ä¼ ç»™ `TransformEngine` è¿›è¡Œç¼ºå¤±å€¼æ’è¡¥å’Œæ ‡å‡†åŒ–ã€‚
* è¿›å…¥æ·±åº¦å­¦ä¹ /æœºå™¨å­¦ä¹ æ¨¡å‹ã€‚



---
